<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Clasificador de elementos patrimoniales</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 0; background: #f6f7fb; color: #111; }
    .wrap { max-width: 900px; margin: 0 auto; padding: 16px; }
    .card { background: white; border-radius: 14px; padding: 16px; box-shadow: 0 6px 20px rgba(0,0,0,.06); margin: 12px 0; }
    h1 { font-size: 20px; margin: 0 0 8px; }
    .row { display: grid; grid-template-columns: 1fr; gap: 10px; }
    label { font-weight: 600; font-size: 14px; }
    input, select, button { font-size: 16px; padding: 10px 12px; border-radius: 10px; border: 1px solid #d8dbe6; width: 100%; box-sizing: border-box; }
    button { border: 0; background: #2563eb; color: white; font-weight: 700; cursor: pointer; }
    button.secondary { background: #111827; }
    button.ghost { background: transparent; color: #111; border: 1px solid #d8dbe6; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .muted { color: #555; font-size: 13px; }
    .pill { display: inline-block; padding: 4px 10px; border-radius: 999px; background: #eef2ff; color: #1e40af; font-weight: 700; font-size: 12px; }
    .gridQ { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 760px){ .gridQ { grid-template-columns: 1fr 1fr; } }
    .q { border: 1px solid #eef0f7; border-radius: 12px; padding: 12px; background: #fafbff; }
    .q h3 { margin: 0 0 8px; font-size: 15px; }
    .result { white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background: #0b1220; color: #e5e7eb; padding: 12px; border-radius: 12px; overflow:auto; }
    .twoCol { display:grid; gap:12px; }
    @media (min-width: 760px){ .twoCol { grid-template-columns: 1fr 1fr; } }
    .box { border:1px solid #eef0f7; border-radius: 12px; padding: 12px; background:#fafbff; }
    .box h3 { margin:0 0 8px; font-size: 14px; }
    ul { margin: 0; padding-left: 18px; }
    .small { font-size: 12px; }
  </style>
</head>

<body>
<div class="wrap">

  <div class="card">
    <h1>Clasificador de elementos patrimoniales</h1>
    <div class="muted">Modo estudio (EBAU Madrid): cada tanda cambia. Guarda tu último intento, tu mejor intento y lo que aún no te ha salido.</div>
  </div>

  <div class="card">
    <div class="row">
      <div>
        <label>Nombre y apellidos</label>
        <input id="alumno" placeholder="Ej: Laura García López" autocomplete="name">
        <div class="muted">Escríbelo siempre igual para ver tu historial.</div>
      </div>

      <div>
        <label>Modo estudio</label>
        <select id="num">
          <option value="30" selected>Estudiar 30 elementos</option>
          <option value="35">Estudiar 35 elementos</option>
          <option value="50">Estudiar TODOS (50)</option>
        </select>
      </div>

      <div style="display:grid; gap:10px;">
        <button id="btnStart">Empezar</button>
        <button id="btnNueva" class="secondary" disabled>Nueva tanda (cambia preguntas)</button>
        <button id="btnReset" class="ghost" disabled>Eliminar mi historial (este dispositivo)</button>
      </div>
    </div>
  </div>

  <div class="card" id="zonaProgreso" style="display:none;">
    <div class="twoCol">
      <div class="box">
        <h3>Último intento</h3>
        <div id="ultimoIntento" class="muted">—</div>
      </div>
      <div class="box">
        <h3>Mejor intento</h3>
        <div id="mejorIntento" class="muted">—</div>
      </div>
    </div>
    <div style="height:10px"></div>
    <div class="box">
      <h3>Elementos que aún no te han aparecido</h3>
      <div id="faltanResumen" class="muted">—</div>
      <div id="faltanLista" class="small" style="margin-top:8px;"></div>
    </div>
  </div>

  <div class="card" id="zonaPreguntas" style="display:none;">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <div class="pill" id="estado"></div>
      <button id="btnEnviar" disabled>Corregir</button>
    </div>
    <div style="height:10px"></div>
    <div class="gridQ" id="preguntas"></div>
  </div>

  <div class="card" id="zonaResultado" style="display:none;">
    <h2 style="margin:0 0 10px;">Resultado de esta tanda</h2>
    <div id="resumen"></div>
    <div style="height:10px"></div>
    <div class="result" id="detalle"></div>
  </div>

</div>

<script>
/* ================= BANCO DE ELEMENTOS (50 – EBAU MADRID) ================= */

const MASAS = [
  "Activo no corriente",
  "Activo corriente",
  "Patrimonio neto",
  "Pasivo no corriente",
  "Pasivo corriente"
];

const ELEMENTOS = {
  // ACTIVO NO CORRIENTE (14)
  "Terrenos y bienes naturales": "Activo no corriente",
  "Construcciones": "Activo no corriente",
  "Instalaciones técnicas": "Activo no corriente",
  "Maquinaria": "Activo no corriente",
  "Utillaje": "Activo no corriente",
  "Mobiliario": "Activo no corriente",
  "Equipos para procesos de información": "Activo no corriente",
  "Elementos de transporte": "Activo no corriente",
  "Inmovilizado en curso": "Activo no corriente",
  "Aplicaciones informáticas": "Activo no corriente",
  "Propiedad industrial": "Activo no corriente",
  "Patentes": "Activo no corriente",
  "Fondo de comercio": "Activo no corriente",
  "Inversiones financieras a largo plazo": "Activo no corriente",

  // ACTIVO CORRIENTE (16)
  "Mercaderías": "Activo corriente",
  "Materias primas": "Activo corriente",
  "Productos en curso": "Activo corriente",
  "Productos terminados": "Activo corriente",
  "Envases y embalajes": "Activo corriente",
  "Anticipos a proveedores": "Activo corriente",
  "Clientes": "Activo corriente",
  "Clientes, efectos comerciales a cobrar": "Activo corriente",
  "Deudores": "Activo corriente",
  "Deudores varios": "Activo corriente",
  "Hacienda Pública deudora": "Activo corriente",
  "Inversiones financieras a corto plazo": "Activo corriente",
  "Bancos": "Activo corriente",
  "Caja": "Activo corriente",
  "Efectos comerciales a cobrar": "Activo corriente",
  "Existencias": "Activo corriente",

  // PATRIMONIO NETO (8)
  "Capital social": "Patrimonio neto",
  "Capital pendiente de desembolso": "Patrimonio neto",
  "Prima de emisión": "Patrimonio neto",
  "Reservas legales": "Patrimonio neto",
  "Reservas voluntarias": "Patrimonio neto",
  "Resultado del ejercicio": "Patrimonio neto",
  "Resultados de ejercicios anteriores": "Patrimonio neto",
  "Subvenciones oficiales de capital": "Patrimonio neto",

  // PASIVO NO CORRIENTE (6)
  "Préstamos a largo plazo": "Pasivo no corriente",
  "Deudas a largo plazo con entidades de crédito": "Pasivo no corriente",
  "Proveedores de inmovilizado a largo plazo": "Pasivo no corriente",
  "Empréstitos": "Pasivo no corriente",
  "Provisiones a largo plazo": "Pasivo no corriente",
  "Pasivo por impuesto diferido": "Pasivo no corriente",

  // PASIVO CORRIENTE (6)
  "Proveedores": "Pasivo corriente",
  "Acreedores": "Pasivo corriente",
  "Deudas a corto plazo con entidades de crédito": "Pasivo corriente",
  "Hacienda Pública acreedora": "Pasivo corriente",
  "Organismos de la Seguridad Social acreedores": "Pasivo corriente",
  "Remuneraciones pendientes de pago": "Pasivo corriente"
};

const ALL_ITEMS = Object.keys(ELEMENTOS);

/* ================= CONFIG NOTA / ESTADO ================= */

const NOTA_MAX = 10;
const PENAL = 0.5;

let seleccion = [];
let respuestas = {};
let alumnoActualKey = "";

/* ================= HELPERS DOM ================= */

const $ = id => document.getElementById(id);

function shuffle(arr){
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function normalizarNombre(s){
  return (s || "")
    .trim()
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")   // elimina acentos
    .replace(/\s+/g, " ");            // colapsa espacios
}

function formatFecha(ms){
  const d = new Date(ms);
  const pad = n => String(n).padStart(2,"0");
  return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

/* ================= PERSISTENCIA (localStorage) =================
   Guardamos por alumno (por nombre normalizado) en este dispositivo.
   Estructura:
   {
     seen: { "Elemento": true, ... },      // elementos que ya le han aparecido alguna vez
     attempts: [
       { ts, n, aciertos, fallos, nota, seleccion: [...], errores: [...] }
     ]
   }
*/

function storageKeyForAlumno(nombre){
  return "clasificador_ebau_mad_v1|" + normalizarNombre(nombre);
}

function loadData(key){
  try{
    const raw = localStorage.getItem(key);
    if(!raw) return { seen: {}, attempts: [] };
    const obj = JSON.parse(raw);
    if(!obj || typeof obj !== "object") return { seen: {}, attempts: [] };
    if(!obj.seen || typeof obj.seen !== "object") obj.seen = {};
    if(!Array.isArray(obj.attempts)) obj.attempts = [];
    return obj;
  } catch {
    return { seen: {}, attempts: [] };
  }
}

function saveData(key, data){
  localStorage.setItem(key, JSON.stringify(data));
}

function computeBestAttempt(attempts){
  if(!attempts.length) return null;
  // Mejor por nota; si empate, por más aciertos; si empate, más reciente
  return attempts.reduce((best, a) => {
    if(!best) return a;
    if(a.nota > best.nota) return a;
    if(a.nota === best.nota && a.aciertos > best.aciertos) return a;
    if(a.nota === best.nota && a.aciertos === best.aciertos && a.ts > best.ts) return a;
    return best;
  }, null);
}

function renderProgreso(nombre){
  const key = storageKeyForAlumno(nombre);
  const data = loadData(key);

  const last = data.attempts.length ? data.attempts[data.attempts.length - 1] : null;
  const best = computeBestAttempt(data.attempts);

  $("zonaProgreso").style.display = "";

  $("ultimoIntento").innerHTML = last
    ? `<b>${last.nota.toFixed(2)}/10</b> — Aciertos ${last.aciertos}/${last.n} — Fallos ${last.fallos} — ${formatFecha(last.ts)}`
    : "Aún no has hecho intentos en este dispositivo.";

  $("mejorIntento").innerHTML = best
    ? `<b>${best.nota.toFixed(2)}/10</b> — Aciertos ${best.aciertos}/${best.n} — Fallos ${best.fallos} — ${formatFecha(best.ts)}`
    : "Aún no hay mejor intento (haz el primero).";

  const seenSet = data.seen || {};
  const faltan = ALL_ITEMS.filter(el => !seenSet[el]);

  $("faltanResumen").textContent = `Te faltan ${faltan.length} de ${ALL_ITEMS.length} elementos por ver.`;
  $("faltanLista").innerHTML = faltan.length
    ? `<ul>${faltan.map(x => `<li>${x}</li>`).join("")}</ul>`
    : "✅ Ya te han aparecido todos los elementos al menos una vez.";

  // Habilitar botón reset para ese alumno
  $("btnReset").disabled = false;
}

/* ================= UI PREGUNTAS / CORRECCIÓN ================= */

function renderPreguntas(){
  $("zonaPreguntas").style.display = "";
  $("zonaResultado").style.display = "none";
  $("preguntas").innerHTML = "";
  respuestas = {};
  $("estado").textContent = `Preguntas: ${seleccion.length}`;

  seleccion.forEach(el => {
    const div = document.createElement("div");
    div.className = "q";
    div.innerHTML = `
      <h3>${el}</h3>
      <label>Selecciona la masa</label>
      <select>
        <option value="" selected>— Elige —</option>
        ${MASAS.map(m => `<option value="${m}">${m}</option>`).join("")}
      </select>
    `;
    const sel = div.querySelector("select");
    sel.addEventListener("change", () => {
      respuestas[el] = sel.value;
      const completas = seleccion.every(x => respuestas[x] && respuestas[x].trim().length > 0);
      $("btnEnviar").disabled = !completas;
    });
    $("preguntas").appendChild(div);
  });
}

function corregir(){
  let fallos = 0;
  const errores = [];
  seleccion.forEach(el => {
    const elegida = respuestas[el] || "";
    const correcta = ELEMENTOS[el];
    if (elegida !== correcta) {
      fallos++;
      errores.push({ elemento: el, tu_masa: elegida || "—", correcta });
    }
  });

  const aciertos = seleccion.length - fallos;
  let nota = NOTA_MAX - (fallos * PENAL);
  if (nota < 0) nota = 0;
  nota = Math.round(nota * 100) / 100;

  return { aciertos, fallos, nota, errores, n: seleccion.length };
}

/* ================= FLUJO PRINCIPAL ================= */

function iniciarTanda(){
  const nombre = $("alumno").value.trim();
  if (nombre.length < 3){
    alert("Escribe nombre y apellidos (mínimo 3 caracteres).");
    return;
  }

  alumnoActualKey = storageKeyForAlumno(nombre);

  // Carga progreso/historial
  renderProgreso(nombre);

  // Selección aleatoria nueva (cada vez)
  const n = parseInt($("num").value, 10);
  const lista = shuffle(ALL_ITEMS);
  seleccion = lista.slice(0, Math.min(n, ALL_ITEMS.length));

  // Marcar como "vistos" los elementos que han aparecido en esta tanda
  const data = loadData(alumnoActualKey);
  seleccion.forEach(el => data.seen[el] = true);
  saveData(alumnoActualKey, data);

  // Actualiza “faltan” tras marcar vistos
  renderProgreso(nombre);

  // Render de preguntas
  renderPreguntas();
  $("btnNueva").disabled = false;
  $("btnEnviar").disabled = true;
}

function guardarIntento(resultado){
  const data = loadData(alumnoActualKey);
  const intento = {
    ts: Date.now(),
    n: resultado.n,
    aciertos: resultado.aciertos,
    fallos: resultado.fallos,
    nota: resultado.nota,
    seleccion: [...seleccion],
    errores: resultado.errores
  };
  data.attempts.push(intento);
  saveData(alumnoActualKey, data);
}

/* ================= EVENTOS ================= */

$("btnStart").addEventListener("click", iniciarTanda);
$("btnNueva").addEventListener("click", iniciarTanda);

$("btnEnviar").addEventListener("click", () => {
  const nombre = $("alumno").value.trim();
  if (!alumnoActualKey || alumnoActualKey !== storageKeyForAlumno(nombre)){
    // Por si el alumno cambia el nombre a mitad
    alumnoActualKey = storageKeyForAlumno(nombre);
  }

  const r = corregir();

  // Guarda intento
  guardarIntento(r);

  // Muestra resultado de esta tanda
  $("zonaResultado").style.display = "";
  $("resumen").innerHTML = `
    <div><b>Alumno:</b> ${nombre}</div>
    <div><b>Aciertos:</b> ${r.aciertos}/${r.n}</div>
    <div><b>Fallos:</b> ${r.fallos}</div>
    <div><b>Nota:</b> ${r.nota.toFixed(2)} / 10</div>
    <div class="muted">Penalización: -${PENAL} por fallo</div>
  `;

  const lines = [];
  if (r.errores.length === 0){
    lines.push("✅ Todo correcto.");
  } else {
    lines.push("❌ Errores:");
    r.errores.forEach(e => {
      lines.push(`- ${e.elemento}`);
      lines.push(`  Tu respuesta: ${e.tu_masa}`);
      lines.push(`  Correcta:     ${e.correcta}`);
      lines.push("");
    });
  }
  $("detalle").textContent = lines.join("\n");

  // Actualiza panel de progreso (último y mejor)
  renderProgreso(nombre);
});

$("btnReset").addEventListener("click", () => {
  const nombre = $("alumno").value.trim();
  if (nombre.length < 3){
    alert("Escribe tu nombre para eliminar tu historial en este dispositivo.");
    return;
  }
  const key = storageKeyForAlumno(nombre);
  localStorage.removeItem(key);

  $("zonaProgreso").style.display = "none";
  $("zonaPreguntas").style.display = "none";
  $("zonaResultado").style.display = "none";
  $("btnNueva").disabled = true;
  $("btnReset").disabled = true;

  alert("Historial eliminado en este dispositivo para: " + nombre);
});
</script>

</body>
</html>










